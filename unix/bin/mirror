#!/usr/bin/env bash

# Check dependencies.
if [ -z $(which wget) ]; then
    echo "fatal: wget is not installed"
    exit 1
fi

# Check arguments.
if [ $# -lt 1 ]; then
    echo "usage: $0 <url> [<rate limit>]" >&2
    echo "example: $0 http://www.example.com/foo/ 100k" >&2
    exit 2
fi

# Check that we have somewhere to put the files.
dir="$HOME/www/mirrors"
if [ ! -e "$dir" ]; then
    mkdir -p "$dir"
fi
if [ ! -d "$dir" ]; then
    echo "fatal: target directory does not exist: $dir"
    exit 3
fi
if [ ! -w "$dir" ]; then
    echo "fatal: cannot write to the target directory: $dir"
    exit 4
fi

# $ man wget
#  -k,  --convert-links      make links in downloaded HTML or CSS point to local files.
#  -m,  --mirror             shortcut for -N -r -l inf --no-remove-listing.
#  -np, --no-parent          don't ascend to the parent directory.
#  -p,  --page-requisites    get all images, etc. needed to display HTML page.
#  -P,  --directory-prefix=  Set directory prefix to prefix.
#       --limit-rate=amount  Limit the download speed to amount bytes per second.
#
#  -N,  --timestamping       Turn on time-stamping.
#  -r,  --recursive          specify recursive download.
#  -l,  --level=NUMBER       maximum recursion depth (inf or 0 for infinite).
#       --no-remove-listing  Don't remove the temporary .listing files generated by FTP retrievals.
if [ -n "$2" ]; then
    wget -m -k -p -np -P "$dir" --limit-rate="$2" "$1"
else
    wget -m -k -p -np -P "$dir" "$1"
fi

exit $?
